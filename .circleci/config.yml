version: 2
jobs:
  build:
    docker:
      - image: awav/tensorflow:2.1
        environment:
          DOCS: True

    steps:
      - checkout
      - run:
          name: Install GPflow
          command: |
            pip install -U pip
            pip install -q git+git://github.com/GPflow/GPflow.git
            pip install -q -r tests_requirements.txt
            git clone --branch vincent/docs https://github.com/GPflow/GPflow.git
      - run:
          name: Make notebooks
          command: |
            make -C GPflow/notebooks -j 4
            cp --parents GPflow/notebooks/*.ipynb doc/source
            cp --parents GPflow/notebooks/*/*.ipynb doc/source
            rm -r doc/source/notebooks
            mv doc/source/GPflow/notebooks doc/source/
            rm -r doc/source/GPflow
      - run:
          name: Commit
          command: |
            git config user.email "docs.bot@gpflow.com"
            git config user.name "Docs Bot"
            git add -f doc/source/notebooks/*.ipynb
            git add -f doc/source/notebooks/*/*.ipynb
            git commit -m "Update notebooks [ci skip]"
            git push origin vincent/setup-build

      - run: echo "Notebooks created"
